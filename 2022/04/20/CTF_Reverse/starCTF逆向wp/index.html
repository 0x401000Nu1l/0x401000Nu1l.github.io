<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="你越安静,你能听到的就越多" href="https://0x401000nu1l.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="你越安静,你能听到的就越多" href="https://0x401000nu1l.github.io/atom.xml"><link rel="alternate" type="application/json" title="你越安静,你能听到的就越多" href="https://0x401000nu1l.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Reverse_wp_starCTF"><link rel="canonical" href="https://0x401000nu1l.github.io/2022/04/20/CTF_Reverse/starCTF%E9%80%86%E5%90%91wp/"><title>starCTF逆向wp | 那我就让时光倒流 = 你越安静,你能听到的就越多</title><meta name="generator" content="Hexo 6.1.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">starCTF逆向wp</h1><div class="meta"><span class="item" title="Created: 2022-04-20 15:43:59"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-04-20T15:43:59+08:00">2022-04-20</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>6.9k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>6 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">那我就让时光倒流</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclhnx9glj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeubcbajj20zk0m8h1h.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giciundwu5j20zk0m8n9e.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeun65urj20zk0m81ii.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giph47e9vtj20zk0m8x6l.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeuibk9fj20zk0m8ay2.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://0x401000nu1l.github.io/2022/04/20/CTF_Reverse/starCTF%E9%80%86%E5%90%91wp/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="那我就让时光倒流"><meta itemprop="description" content=", (σﾟ∀ﾟ)σ..:*☆哎哟不错哦"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="你越安静,你能听到的就越多"></span><div class="body md" itemprop="articleBody"><h2 id="starctf-reverse-wirteup"><a class="anchor" href="#starctf-reverse-wirteup">#</a> StarCTF Reverse wirteup</h2><p><span class="exturl" data-url="aHR0cHM6Ly9hZHdvcmxkLnhjdGYub3JnLmNuL21hdGNoL2NvbnRlc3RfY2hhbGxlbmdlP2V2ZW50PTE4NCZhbXA7aGFzaD0zM2QxZWM5MS02YzFkLTRjMzMtOWZmMi01NThjODAyY2VkOTIuZXZlbnQ=">赛题 - *CTF (xctf.org.cn)</span></p><h4 id="simple-file-system"><a class="anchor" href="#simple-file-system">#</a> Simple File System</h4><p>观察压缩包各文件</p><p><img data-src="image-20220420155056064.png" alt="image-20220420155056064"></p><p>按照 instruction.txt 文件描述打开文件</p><p><img data-src="image-20220420155341226.png" alt="image-20220420155341226"></p><p>直接拖到 IDA 里面打开通过查找字符串进入主要函数</p><p><img data-src="image-20220420160044266.png" alt="image-20220420160044266"></p><p>找到关键词 &quot;plantflag&quot;, 之后进入 key_func 函数</p><p><img data-src="image-20220420160244006.png" alt="image-20220420160244006"></p><p>进入 get_flag 函数</p><p><img data-src="image-20220420160323840.png" alt="image-20220420160323840"></p><p>经典的加密函数，但是 v4 的值未知，而且密文也是未知，所以在这里采用动态调试获取</p><p><img data-src="image-20220420162015950.png" alt="image-20220420162015950"></p><p>运行之后查看 V5 的值发现是 flag 的格式，所以判定是将读入的值一步步加密，但是最后的密文在哪里呢，附件压缩包中有两个额外文件，打开查看</p><p><img data-src="image-20220420164207583.png" alt="image-20220420164207583"></p><p>其中一个文件是规定 flag 格式，另一个中有很多字段，继续动态调试执行加密步骤</p><p><img data-src="image-20220420164325335.png" alt="image-20220420164325335"></p><p>这是 V4 的值</p><p><img data-src="image-20220420165155556.png" alt="image-20220420165155556"></p><p>这是加密前几次后出现的前几位密文猜测密文应该是保存在 image.flag 文件中，所以直接在 image.flag 中查找</p><p><img data-src="image-20220420165350483.png" alt="image-20220420165350483"></p><p>果然查到了密文，将密文剪切出来然后写脚本逆向解密</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">decode2</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    flag <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        v5 <span class="token operator">=</span> flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        v5 <span class="token operator">=</span> <span class="token punctuation">(</span>v5<span class="token operator">>></span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>v5<span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xff</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        v5 <span class="token operator">^</span><span class="token operator">=</span> <span class="token number">0xDE</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        v5 <span class="token operator">=</span> <span class="token punctuation">(</span>v5<span class="token operator">>></span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>v5<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        v5 <span class="token operator">^</span><span class="token operator">=</span> <span class="token number">0xED</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        v5 <span class="token operator">=</span> <span class="token punctuation">(</span>v5<span class="token operator">>></span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>v5<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xff</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        v5 <span class="token operator">^</span><span class="token operator">=</span><span class="token number">0xBE</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        v5 <span class="token operator">=</span> <span class="token punctuation">(</span>v5<span class="token operator">>></span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>v5<span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xff</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        v5 <span class="token operator">^</span><span class="token operator">=</span><span class="token number">0xEF</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        v5 <span class="token operator">=</span> <span class="token punctuation">(</span>v5<span class="token operator">>></span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>v5<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xff</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        flag <span class="token operator">+=</span><span class="token builtin">chr</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> flag</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>flag1 <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'C:\\Users\\Ikhan\\desktop\\image.flag'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>decode2<span class="token punctuation">(</span>flag1<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token triple-quoted-string string">'''</span></pre></td></tr><tr><td data-num="20"></td><td><pre>*CTF&#123;Gwed9VQpM4Lanf0kEj1oFJR6&#125;</pre></td></tr><tr><td data-num="21"></td><td><pre>'''</pre></td></tr></table></figure><p>得到最后的 flag</p><blockquote><p>*<strong>CTF{Gwed9VQpM4Lanf0kEj1oFJR6}</strong></p></blockquote><h4 id="nacl"><a class="anchor" href="#nacl">#</a> NaCl</h4><p>进入 IDA</p><p><img data-src="image-20220428204720717.png" alt="image-20220428204720717"></p><p>条理很清楚，进入 encode () 函数</p><p><img data-src="image-20220428204816137.png" alt="image-20220428204816137"></p><p>逻辑太混乱了，准备动态调试看看，在 encode () 前面打断点，然后进入</p><p><img data-src="image-20220428205208913.png" alt="image-20220428205208913"></p><p><img data-src="image-20220428205226813.png" alt="image-20220428205226813"></p><p>前后发现很反常的事情，不断地对 R15 寄存器进行运算，继续往下看，连续 jmp 了几个地址之后</p><p><img data-src="image-20220428205430701.png" alt="image-20220428205430701"></p><p>发现是出现了 jmp rdi 的操作<br><strong>IDA 反汇编遇到 jmp 寄存器 这样的指令可能无法准确地反汇编</strong><br>btw，网上看了几位大佬的 wp 发现大佬们没去花指令的时候这一步 F5 不了，但是我没去花指令的情况下仍然是给 F5 出来了，但是有点逻辑混乱，可能是因为我的 IDA 版本更高点</p><p>继续看关注 R15 寄存器，在 encode () 函数刚开始时执行了<br><strong>sub R15,28h</strong><br>紧接着后面跳转的时候又拓展了 R15 附近的区域，将下面要跳转的函数执行完需要执行的地址放入 R15 附近的内存，并且跳转之后<br>**jmp rdi **<br>这里 rdi 的取值是从 R15 附近取出来然后再赋给 RDI</p><p><strong>所以，这里的 R15 充当的就是栈指针寄存器的作用，与此同时，前面不断地 jmp 地址</strong><br><strong>就相当于 call，而后面的 jmp rdi 就相当于 retn</strong><br>这个也算是一种花指令，现在写脚本 patch 源程序。<br>参考<span class="exturl" data-url="aHR0cHM6Ly9kMW5uM3IuZ2l0aHViLmlvLzIwMTkvMDYvMTAvSURBUHl0aG9uLw==">大佬整理的 IDAPython 常用函数</span></p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>start <span class="token operator">=</span> <span class="token number">0x807FEC0</span></pre></td></tr><tr><td data-num="2"></td><td><pre>end <span class="token operator">=</span> <span class="token number">0x8080AD1</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>address <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>callTarget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"lea"</span><span class="token punctuation">,</span> <span class="token string">"lea"</span><span class="token punctuation">,</span> <span class="token string">"mov"</span><span class="token punctuation">,</span> <span class="token string">"jmp"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>retnTarget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"lea"</span><span class="token punctuation">,</span> <span class="token string">"mov"</span><span class="token punctuation">,</span> <span class="token string">"and"</span><span class="token punctuation">,</span> <span class="token string">"lea"</span><span class="token punctuation">,</span> <span class="token string">"jmp"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">def</span> <span class="token function">nop</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;</span> e<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		patch_byte<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		s <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">def</span> <span class="token function">turnCall</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token comment"># nop 掉 call 之前的值</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	nop<span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	patch_byte<span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token number">0xE8</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token comment"># 把后面的花指令去掉 重新计算去花长度</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	huaStart <span class="token operator">=</span> next_head<span class="token punctuation">(</span>e<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	huaEnd <span class="token operator">=</span> h</pre></td></tr><tr><td data-num="21"></td><td><pre>	nop<span class="token punctuation">(</span>huaStart<span class="token punctuation">,</span> huaEnd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">def</span> <span class="token function">turnRetn</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	nop<span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token comment"># 注意原来是 jmp xxx</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token comment"># 所以前面 nop 掉一个 后面改成 retn</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	patch_byte<span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	patch_byte<span class="token punctuation">(</span>e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xC3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>p <span class="token operator">=</span> start</pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">while</span> p <span class="token operator">&lt;</span> end<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	address<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p</pre></td></tr><tr><td data-num="33"></td><td><pre>	address<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> next_head<span class="token punctuation">(</span>p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	address<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> next_head<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	address<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> next_head<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	address<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> next_head<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>	<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>		<span class="token keyword">if</span> print_insn_mnem<span class="token punctuation">(</span>address<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> callTarget<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>			<span class="token keyword">break</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	<span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>		turnCall<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> get_operand_value<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>		p <span class="token operator">=</span> next_head<span class="token punctuation">(</span>next_head<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>		<span class="token keyword">continue</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>	<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>		<span class="token keyword">if</span> print_insn_mnem<span class="token punctuation">(</span>address<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> retnTarget<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>			<span class="token keyword">break</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		turnRetn<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		p <span class="token operator">=</span> next_head<span class="token punctuation">(</span>next_head<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>		<span class="token keyword">continue</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>	p <span class="token operator">=</span> next_head<span class="token punctuation">(</span>p<span class="token punctuation">)</span></pre></td></tr></table></figure><p>patch 之后保存修改后的文件，继续用 IDA 打开。<br><img data-src="image-20220428211527538.png" alt="image-20220428211527538"></p><p>进入 encode () 函数之后，继续创建一个结构体让程序更清楚一点，</p><p><img data-src="image-20220428215634541.png" alt="image-20220428215634541"></p><p>进入主要函数 <strong>sub_8080100</strong>, 继续创建结构体 (自创结构体)<br>发现一共结构体一共 48 个字节，就可以看做是 12 个 int 或者 6 个 long，这里创建 12 个 int<br>然后创建我们的结构体，发现界面会清楚一点，而且很容易看出来是 XTEA 加密</p><p>但是经过了魔改，循环的轮数以及 delta 数值也发生了变化</p><p><span class="exturl" data-url="aHR0cHM6Ly9iYnMucGVkaXkuY29tL3RocmVhZC0yNjY5MzMuaHRt">TEA XTEA XXTEA 加密</span><br><img data-src="image-20220428221544843.png" alt="image-20220428221544843"></p><p>这里取 key 的操作学到了，先按 d 让单个元素的变成 8 位，然后再创建一个包含四个元素的数组，就能创建一个总共 32 位的数组。<br><img data-src="image-20220428220355543.png" alt="image-20220428220355543"></p><p>还有一个坑是<img data-src="image-20220428220439172.png" alt="image-20220428220439172"></p><p>这里传入的 XTEA 每一步的循环的值都是变化的，但是经过计算就能得到循环值分别为 <strong>2 4 6 8</strong><br><img data-src="image-20220428220817309.png" alt="image-20220428220817309"></p><p>而且 xorkey 是可以通过动调获取的</p><p>下一个函数就是简单的 memcpy () 函数，</p><blockquote><p>C 库函数 <strong>void *memcpy(void *str1, const void *str2, size_t n)</strong> 从存储区 <strong>str2</strong> 复制 <strong>n</strong> 个字节到存储区 <strong>str1</strong>。</p></blockquote><p><img data-src="C:%5CUsers%5CIkhan%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220429171011925.png" alt="image-20220429171011925"></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>__int64 __fastcall <span class="token function">XOR</span><span class="token punctuation">(</span>__int64 input<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  __int64 v1<span class="token punctuation">;</span> <span class="token comment">// rbx</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  __int64 v2<span class="token punctuation">;</span> <span class="token comment">// r13</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// r15</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  _QWORD <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// r15</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  struct_v5 <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment">// r15</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// ebx</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment">// ebx</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  v4 <span class="token operator">=</span> <span class="token punctuation">(</span>v3 <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token operator">*</span>v4 <span class="token operator">=</span> v1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  v5 <span class="token operator">=</span> <span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token punctuation">(</span>v4 <span class="token operator">-</span> <span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  v5<span class="token operator">-></span>input <span class="token operator">=</span> input<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  v5<span class="token operator">-></span>xorKey <span class="token operator">=</span> <span class="token function">sub_8080360</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  v5<span class="token operator">-></span>input1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> v5<span class="token operator">-></span>input<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  v5<span class="token operator">-></span>highFour <span class="token operator">=</span> <span class="token function">Big</span><span class="token punctuation">(</span><span class="token function">HIDWORD</span><span class="token punctuation">(</span>v5<span class="token operator">-></span>input1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 高四位小端序放入</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  v5<span class="token operator">-></span>lowFour <span class="token operator">=</span> <span class="token function">Big</span><span class="token punctuation">(</span>v5<span class="token operator">-></span>input1<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 低四位小端序放入</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span> v5<span class="token operator">-></span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v5<span class="token operator">-></span>count <span class="token operator">&lt;=</span> <span class="token number">43</span><span class="token punctuation">;</span> <span class="token operator">++</span>v5<span class="token operator">-></span>count <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    v5<span class="token operator">-></span>orgLowFour <span class="token operator">=</span> v5<span class="token operator">-></span>lowFour<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    v6 <span class="token operator">=</span> <span class="token function">ROL</span><span class="token punctuation">(</span>v5<span class="token operator">-></span>lowFour<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    v7 <span class="token operator">=</span> <span class="token function">ROL</span><span class="token punctuation">(</span>v5<span class="token operator">-></span>lowFour<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> v6<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    v5<span class="token operator">-></span>lowFour <span class="token operator">=</span> v5<span class="token operator">-></span>highFour <span class="token operator">^</span> v7 <span class="token operator">^</span> <span class="token function">ROL</span><span class="token punctuation">(</span>v5<span class="token operator">-></span>lowFour<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> v5<span class="token operator">-></span>count <span class="token operator">+</span> v5<span class="token operator">-></span>xorKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    v5<span class="token operator">-></span>highFour <span class="token operator">=</span> v5<span class="token operator">-></span>orgLowFour<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  v5<span class="token operator">-></span>input1 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  v5<span class="token operator">-></span>input1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v5<span class="token operator">-></span>input1 <span class="token operator">|</span> v5<span class="token operator">-></span>lowFour<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> v5<span class="token operator">-></span>highFour<span class="token punctuation">;</span><span class="token comment">// 低高互换</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">return</span> v5<span class="token operator">-></span>input1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>输入的 input 还要经过一个异或运算，再有结尾的高低 32 位转换<br>并且，后面是魔改的 XTEA</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>__int64 __fastcall <span class="token function">XTEA</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  __int64 v2<span class="token punctuation">;</span> <span class="token comment">// r13</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  myst <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// r15</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t1 <span class="token operator">=</span> count<span class="token punctuation">;</span>                            <span class="token comment">// 轮数为传入的轮数，分别是 2 4 8 16</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token operator">*</span><span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0 <span class="token operator">=</span> a2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token operator">*</span><span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>                           <span class="token comment">//key 可以直接拿</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token operator">*</span><span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token operator">*</span><span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta <span class="token operator">=</span> <span class="token number">0x10325476</span><span class="token punctuation">;</span>                    <span class="token comment">//delta 数变了</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t9 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t9 <span class="token operator">&lt;</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t1<span class="token punctuation">;</span> <span class="token operator">++</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t9 <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0 <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v1 <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v1<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                                                                      <span class="token operator">+</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">+=</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v1 <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0 <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>v2</pre></td></tr><tr><td data-num="20"></td><td><pre>                                                                        <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">>></span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                                                                        <span class="token operator">+</span> <span class="token operator">*</span><span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                                                                      <span class="token operator">+</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token operator">*</span><span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0<span class="token punctuation">)</span> <span class="token operator">=</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  result <span class="token operator">=</span> v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token operator">*</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token operator">*</span><span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v0 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最后贴出大佬的 wp</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SHL</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> n <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ROTL</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token function">SHL</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">-</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xorKey<span class="token punctuation">[</span><span class="token number">44</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token number">0x04050607</span><span class="token punctuation">,</span> <span class="token number">0x00010203</span><span class="token punctuation">,</span> <span class="token number">0x0C0D0E0F</span><span class="token punctuation">,</span> <span class="token number">0x08090A0B</span><span class="token punctuation">,</span> <span class="token number">0xCD3FE81B</span><span class="token punctuation">,</span> <span class="token number">0xD7C45477</span><span class="token punctuation">,</span> <span class="token number">0x9F3E9236</span><span class="token punctuation">,</span> <span class="token number">0x0107F187</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token number">0xF993CB81</span><span class="token punctuation">,</span> <span class="token number">0xBF74166C</span><span class="token punctuation">,</span> <span class="token number">0xDA198427</span><span class="token punctuation">,</span> <span class="token number">0x1A05ABFF</span><span class="token punctuation">,</span> <span class="token number">0x9307E5E4</span><span class="token punctuation">,</span> <span class="token number">0xCB8B0E45</span><span class="token punctuation">,</span> <span class="token number">0x306DF7F5</span><span class="token punctuation">,</span> <span class="token number">0xAD300197</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token number">0xAA86B056</span><span class="token punctuation">,</span> <span class="token number">0x449263BA</span><span class="token punctuation">,</span> <span class="token number">0x3FA4401B</span><span class="token punctuation">,</span> <span class="token number">0x1E41F917</span><span class="token punctuation">,</span> <span class="token number">0xC6CB1E7D</span><span class="token punctuation">,</span> <span class="token number">0x18EB0D7A</span><span class="token punctuation">,</span> <span class="token number">0xD4EC4800</span><span class="token punctuation">,</span> <span class="token number">0xB486F92B</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token number">0x8737F9F3</span><span class="token punctuation">,</span> <span class="token number">0x765E3D25</span><span class="token punctuation">,</span> <span class="token number">0xDB3D3537</span><span class="token punctuation">,</span> <span class="token number">0xEE44552B</span><span class="token punctuation">,</span> <span class="token number">0x11D0C94C</span><span class="token punctuation">,</span> <span class="token number">0x9B605BCB</span><span class="token punctuation">,</span> <span class="token number">0x903B98B3</span><span class="token punctuation">,</span> <span class="token number">0x24C2EEA3</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token number">0x896E10A2</span><span class="token punctuation">,</span> <span class="token number">0x2247F0C0</span><span class="token punctuation">,</span> <span class="token number">0xB84E5CAA</span><span class="token punctuation">,</span> <span class="token number">0x8D2C04F0</span><span class="token punctuation">,</span> <span class="token number">0x3BC7842C</span><span class="token punctuation">,</span> <span class="token number">0x1A50D606</span><span class="token punctuation">,</span> <span class="token number">0x49A1917C</span><span class="token punctuation">,</span> <span class="token number">0x7E1CB50C</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token number">0xFC27B826</span><span class="token punctuation">,</span> <span class="token number">0x5FDDDFBC</span><span class="token punctuation">,</span> <span class="token number">0xDE0FC404</span><span class="token punctuation">,</span> <span class="token number">0xB2B30907</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token function">decipher</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> num_rounds<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> <span class="token keyword">const</span> key<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">uint32_t</span> v0<span class="token operator">=</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v1<span class="token operator">=</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> delta <span class="token operator">=</span> <span class="token number">0x10325476</span><span class="token punctuation">,</span> sum<span class="token operator">=</span>delta<span class="token operator">*</span>num_rounds<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_rounds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        v1 <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v0 <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v0 <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> v0<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        sum <span class="token operator">-=</span> delta<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        v0 <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v1 <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v1 <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> v1<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>v0<span class="token punctuation">;</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>v1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">void</span> <span class="token function">XorRol</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token class-name">uint32_t</span> encLow <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token class-name">uint32_t</span> encHigh <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token class-name">uint32_t</span> orgLow<span class="token punctuation">,</span> orgHigh<span class="token punctuation">,</span> v6<span class="token punctuation">,</span> v7<span class="token punctuation">,</span> v8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	<span class="token keyword">int</span> i<span class="token punctuation">;</span>	</pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">43</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		orgLow <span class="token operator">=</span> encHigh<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		v6 <span class="token operator">=</span> <span class="token function">ROTL</span><span class="token punctuation">(</span>orgLow<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		v7 <span class="token operator">=</span> <span class="token function">ROTL</span><span class="token punctuation">(</span>orgLow<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> v6<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>		v8 <span class="token operator">=</span> v7 <span class="token operator">^</span> <span class="token function">ROTL</span><span class="token punctuation">(</span>orgLow<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>		orgHigh <span class="token operator">=</span> encLow <span class="token operator">^</span> xorKey<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> v8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>		</pre></td></tr><tr><td data-num="42"></td><td><pre>		encHigh <span class="token operator">=</span> orgHigh<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>		encLow <span class="token operator">=</span> orgLow<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>	v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> orgLow<span class="token punctuation">;</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> orgHigh<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="47"></td><td><pre> </pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token class-name">uint32_t</span> v<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0xFDF5C266</span><span class="token punctuation">,</span> <span class="token number">0x7A328286</span><span class="token punctuation">,</span> <span class="token number">0xCE944004</span><span class="token punctuation">,</span> <span class="token number">0x5DE08ADC</span><span class="token punctuation">,</span> <span class="token number">0xA6E4BD0A</span><span class="token punctuation">,</span> <span class="token number">0x16CAADDC</span><span class="token punctuation">,</span> <span class="token number">0x13CD6F0C</span><span class="token punctuation">,</span> <span class="token number">0x1A75D936</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token class-name">uint32_t</span> k<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0x03020100</span><span class="token punctuation">,</span> <span class="token number">0x07060504</span><span class="token punctuation">,</span> <span class="token number">0x0B0A0908</span><span class="token punctuation">,</span> <span class="token number">0x0F0E0D0C</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token class-name">uint32_t</span> teaData<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	</pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment">//	uint32_t testData[] = &#123; 0xD4C2E7AE, 0xD2E28713 &#125;;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">//	XorRol(testData);</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">//	printf("0x%X, 0x%X, ", testData[0], testData[1]);</span></pre></td></tr><tr><td data-num="58"></td><td><pre>	</pre></td></tr><tr><td data-num="59"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>		<span class="token function">decipher</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%X, 0x%X, "</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>		teaData<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>		teaData<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>	</pre></td></tr><tr><td data-num="67"></td><td><pre>	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>	</pre></td></tr><tr><td data-num="69"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>		<span class="token function">XorRol</span><span class="token punctuation">(</span>teaData <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment">//		printf("0x%X, 0x%X, ", teaData[i * 2], teaData[i * 2 + 1]);</span></pre></td></tr><tr><td data-num="73"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>	</pre></td></tr><tr><td data-num="75"></td><td><pre>	<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>	</pre></td></tr><tr><td data-num="77"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>teaData<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>	<span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="79"></td><td><pre>		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c%c%c%c"</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    </pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>以及出题人的出题思路</p><blockquote><h3 id="nacl-writeup"><a class="anchor" href="#nacl-writeup">#</a> NaCl writeup</h3><ol><li><p>main logic in <code>src.c</code></p></li><li><p>this challenge is likely Google Native NaCl project. It includes jump check, memory check and align check. But I alse replace the stack registers, use r15 to replace rsp, r14 to replace rbp. And here are no call, ret and leave. Here is only jmp. Access memory by adding r13 to get memory address.</p></li><li><p>Moreover, i put the loader function and the native client binary together. the section SFI is NaCl's code, and SFI_DATA is data section.</p></li><li><p>expected solution is as follows: firstly, dump section SFI and SFI_data. Then, you modify the binary by script code. you need to recover stack, register and instrcution call, ret, etc. Lastly, you can disassemble the new binary by ida or other tools. Then you can got simple logic.</p></li><li><p>i am sorry that all players solved this challenge by dynamic debugging and static analysis of orginal assembly code. Because my hide logic code is short. So bad.</p></li></ol></blockquote><div class="tags"><a href="/tags/Reverse-wp-starCTF/" rel="tag"><i class="ic i-tag"></i> Reverse_wp_starCTF</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-04-29 17:16:09" itemprop="dateModified" datetime="2022-04-29T17:16:09+08:00">2022-04-29</time> </span><span id="2022/04/20/CTF_Reverse/starCTF逆向wp/" class="item leancloud_visitors" data-flag-title="starCTF逆向wp" title="Views"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">Views</span> <span class="leancloud-visitors-count"></span> <span class="text">times</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="那我就让时光倒流 WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="那我就让时光倒流 Alipay"><p>Alipay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>那我就让时光倒流 <i class="ic i-at"><em>@</em></i>你越安静,你能听到的就越多</li><li class="link"><strong>Post link: </strong><a href="https://0x401000nu1l.github.io/2022/04/20/CTF_Reverse/starCTF%E9%80%86%E5%90%91wp/" title="starCTF逆向wp">https://0x401000nu1l.github.io/2022/04/20/CTF_Reverse/starCTF逆向wp/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/04/19/Composition-Principles-and-Architecture/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%B0%8F%E7%9A%84elf%E6%96%87%E4%BB%B6/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclffsa1cj20zk0m811l.jpg" title="史上最小的elf文件"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>史上最小的elf文件</h3></a></div><div class="item right"><a href="/2022/04/20/Software-Construction/%E8%BD%AF%E6%9E%84%E5%AD%A6%E4%B9%A0%E4%B8%80/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipewkhf1zj20zk0m81kx.jpg" title="软构学习一"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> Software-Construction</span><h3>软构学习一</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#starctf-reverse-wirteup"><span class="toc-number">1.</span> <span class="toc-text">StarCTF Reverse wirteup</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#simple-file-system"><span class="toc-number">1.0.1.</span> <span class="toc-text">Simple File System</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nacl"><span class="toc-number">1.0.2.</span> <span class="toc-text">NaCl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacl-writeup"><span class="toc-number">1.1.</span> <span class="toc-text">NaCl writeup</span></a></li></ol></div><div class="related panel pjax" data-title="Related"></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="那我就让时光倒流" data-src="/images/avatar.jpg"><p class="name" itemprop="name">那我就让时光倒流</p><div class="description" itemprop="description">(σﾟ∀ﾟ)σ..:*☆哎哟不错哦</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">18</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">1</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">11</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tLzB4NDAxMDAwTnUxbA==" title="https:&#x2F;&#x2F;github.com&#x2F;0x401000Nu1l"><i class="ic i-github"></i></span> <span class="exturl item email" data-url="bWFpbHRvOnhpbmR1MTEwNkBnYW1pbC5jb20=" title="mailto:xindu1106@gamil.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/04/19/Composition-Principles-and-Architecture/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%B0%8F%E7%9A%84elf%E6%96%87%E4%BB%B6/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/04/20/Software-Construction/%E8%BD%AF%E6%9E%84%E5%AD%A6%E4%B9%A0%E4%B8%80/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Software-Construction/" title="In Software-Construction">Software-Construction</a></div><span><a href="/2022/06/13/Software-Construction/%E8%BD%AF%E6%9E%84%E5%AD%A6%E4%B9%A0%E4%BA%94/" title="软构学习五">软构学习五</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/04/19/Composition-Principles-and-Architecture/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%B0%8F%E7%9A%84elf%E6%96%87%E4%BB%B6/" title="史上最小的elf文件">史上最小的elf文件</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/10/04/Programming-Language/%E7%94%A8C%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8ELC-3%E6%8C%87%E4%BB%A4%E9%9B%86%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA/" title="用C语言实现基于LC-3指令集的虚拟机">用C语言实现基于LC-3指令集的虚拟机</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/04/21/CTF_Reverse/CTFshow%E5%8D%B7%E7%8E%8B%E6%9D%AFwp/" title="CTFshow卷王杯wp">CTFshow卷王杯wp</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/05/03/CTF_Reverse/DASCTF%E5%9B%9B%E6%9C%88%E9%80%86%E5%90%91%E9%83%A8%E5%88%86wp/" title="DASCTF X FATE逆向部分wp">DASCTF X FATE逆向部分wp</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/04/13/whispers/plan/" title="plan">plan</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/04/18/Composition-Principles-and-Architecture/%E6%B1%87%E7%BC%96-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" title="汇编语言中系统调用">汇编语言中系统调用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Software-Construction/" title="In Software-Construction">Software-Construction</a></div><span><a href="/2022/04/30/Software-Construction/%E8%BD%AF%E6%9E%84%E5%AD%A6%E4%B9%A0%E4%BA%8C/" title="软构学习二">软构学习二</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Software-Construction/" title="In Software-Construction">Software-Construction</a></div><span><a href="/2022/06/01/Software-Construction/%E8%BD%AF%E6%9E%84%E5%AD%A6%E4%B9%A0%E5%9B%9B/" title="软构学习四">软构学习四</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/06/04/CTF_Reverse/2022CISCN_%E9%80%86%E5%90%91/" title="2022CISCN_逆向">2022CISCN_逆向</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">那我就让时光倒流 @ 那我就让时光倒流</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">105k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">1:35</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/04/20/CTF_Reverse/starCTF逆向wp/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>